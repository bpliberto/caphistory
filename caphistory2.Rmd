---
title: "caphistory2"
author: "Bethany Liberto"
date: "June 16, 2019"
output:
  word_document: default
editor_options:
  chunk_output_type: inline
---

Using CJS and JS. JS -> for population estimates. CJS -> for time-dependent survival and recapture rates of a given species 

```{r setup, include=FALSE}
#knitr::opts_chunk$set(echo = T,
                      #results = "hide") ##This just hides outputs when knitting because it was like 60 pages
options(warn=-1) ##This hides warnings, again, just really for knitting. Can be turned back on with warn=0
```
  
  
```{r}
library(marked)
library(RMark)
library(ggplot2)
library(ggrepel)
library(AICcmodavg)
library(dplyr)
```


abundance/effort AIC vvvv

```{r}

dataA <- read.csv("Dragonfly1718Abundance.csv", stringsAsFactors = F)


### Each possible combination of variables needs to be analyzed.  The lowest score (not counting the full model?) wins. #####
modA1<-glm(Abundance  ~  pH, data= dataA, family = poisson(link="log"), offset(adulteffort))
modA2<-glm(Abundance ~ elevation, data= dataA,family = poisson(link="log"), offset(adulteffort))
modA3<-glm(Abundance ~ fishpresence, data= dataA,family = poisson(link="log"), offset(adulteffort))
modA4<-glm(Abundance ~ lenticlotic,data= dataA, family = poisson(link="log"), offset(adulteffort))  
modA5<-glm(Abundance ~ openwater, data= dataA,family = poisson(link="log"), offset(adulteffort))
modA6<-glm(Abundance ~ pH + elevation + fishpresence + lenticlotic + openwater +airtempdiff,data= dataA, family = poisson(link="log"), offset(adulteffort))
modA7<-glm(Abundance ~ 1,data= dataA, family = poisson(link="log"), offset(adulteffort))
modA8<-glm(Abundance ~ pH + fishpresence,data= dataA, family = poisson(link="log"), offset(adulteffort))
modA9 <- glm(Abundance ~ pH + openwater,data= dataA, family = poisson(link="log"), offset(adulteffort))
modA10 <- glm(Abundance ~ airtempdiff,data= dataA, family = poisson(link="log"), offset(adulteffort))
modA11 <- glm(Abundance ~ elevation + openwater,data= dataA, family = poisson(link="log"), offset(adulteffort))
modA12 <- glm(Abundance ~ elevation + pH,data= dataA, family = poisson(link="log"), offset(adulteffort))


modAR1<-glm(Richness  ~  pH, data= dataA, family = poisson(link="log"), offset(adulteffort))
modAR2<-glm(Richness ~ elevation, data= dataA,family = poisson(link="log"),  offset(adulteffort))
modAR3<-glm(Richness ~ fishpresence, data= dataA,family = poisson(link="log"), offset(adulteffort))
modAR4<-glm(Richness ~ lenticlotic,data= dataA, family = poisson(link="log"), offset(adulteffort))  
modAR5<-glm(Richness ~ openwater, data= dataA,family = poisson(link="log"), offset(adulteffort))
modAR6<-glm(Richness ~ pH + elevation + fishpresence + lenticlotic + openwater +airtempdiff,data= dataA, family = poisson(link="log"), offset(adulteffort))
modAR7<-glm(Richness ~ 1,data= dataA, family = poisson(link="log"))
modAR8<-glm(Richness ~ pH + fishpresence,data= dataA, family = poisson(link="log"), offset(adulteffort))
modAR9 <- glm(Richness ~ pH + openwater,data= dataA, family = poisson(link="log"), offset(adulteffort))
modAR10 <- glm(Richness ~ airtempdiff,data= dataA, family = poisson(link="log"), offset(adulteffort))
modAR11 <- glm(Richness ~ elevation + openwater,data= dataA, family = poisson(link="log"), offset(adulteffort))
modAR12 <- glm(Richness ~ elevation + pH,data= dataA, family = poisson(link="log"), offset(adulteffort))

# make list of models
modelsA <- list(modA6, modA7, modA8, modA9, modA11, modA12)
# names of models
mod_namesA <- c("pH-elevation-fish-lenticlotic-openwater-airtempdiff",
"y=1",
"pH-fish",
"pH-openwater",
"elevation-openwater",
"elevation-pH")
# makde AIC table
aictab(cand.set = modelsA, modnames = mod_namesA)

# make list of models
modelsAR <- list(modAR6, modAR7, modAR8, modAR9, modAR11, modAR12)
# names of models
mod_namesAR <- c("pH-elevation-fish-lenticlotic-openwater-airtempdiff",
"y=1",
"pH-fish",
"pH-openwater",
"elevation-openwater",
"elevation-pH")
# makde AIC table
aictab(cand.set = modelsAR, modnames = mod_namesAR)

```





Nymph Abundance 2018
```{r}
dataB <- read.csv("NymphAbund2018.csv", stringsAsFactors = F)

### Each possible combination of variables needs to be analyzed.  The lowest score (not counting the full model?) wins. #####
modB1<-glm(abundance ~ pH , data= dataB, family = poisson(link="log"), offset(areasampled))
modB2<-glm(abundance ~ elevation, data= dataB, family = poisson(link="log"), offset(areasampled))
modB3<-glm(abundance ~ fishpresence , data= dataB, family = poisson(link="log"), offset(areasampled))
modB4<-glm(abundance ~ lenticlotic, data= dataB, family = poisson(link="log"),+ offset(areasampled))
modB5<-glm(abundance ~ openwatersizem2, data= dataB, family = poisson(link="log"), offset(areasampled))
modB6<-glm(abundance ~ pH+elevation+fishpresence+lenticlotic+openwatersizem2+averagewatertemp, data= dataB, family = poisson(link="log"), offset(areasampled))
modB7<-glm(abundance ~ elevation + fishpresence, data= dataB, family = poisson(link="log"), offset(areasampled))
modB8<-glm(abundance ~ pH +fishpresence, data= dataB, family = poisson(link="log"), offset(areasampled))
modB9 <-glm(abundance ~ pH +openwatersizem2, data= dataB, family = poisson(link="log"), offset(areasampled))
modB10 <- glm(abundance ~1, family=poisson(link="log"), data= dataB, offset(areasampled))
modB11 <- glm(abundance ~averagewatertemp, family=poisson(link="log"), data= dataB, offset(areasampled))
modB12 <-glm(abundance ~ pH +elevation, data= dataB, family = poisson(link="log"), offset(areasampled))

modBR1 <- glm(richness ~ pH , data= dataB, family = poisson(link="log"), offset(areasampled))
modBR2 <- glm(richness ~ elevation, data= dataB, family = poisson(link="log"), offset(areasampled))
modBR3 <- glm(richness ~ fishpresence, data= dataB, family = poisson(link="log"), offset(areasampled))
modBR4 <- glm(richness ~ lenticlotic, data= dataB, family = poisson(link="log"), offset(areasampled))
modBR5 <- glm(richness ~  openwatersizem2, data= dataB, family = poisson(link="log"), offset(areasampled))
modBR6 <- glm(richness ~  pH+elevation+fishpresence+lenticlotic+openwatersizem2+averagewatertemp, data= dataB, family = poisson(link="log"), offset(areasampled))
modBR7<-glm(richness ~ elevation + fishpresence, data= dataB, family = poisson(link="log"), offset(areasampled))
modBR8<-glm(richness ~ pH +fishpresence, data= dataB, family = poisson(link="log"), offset(areasampled))
modBR9 <-glm(richness ~ pH +openwatersizem2, data= dataB, family = poisson(link="log"), offset(areasampled))
modBR10 <- glm(richness ~1, family=poisson(link="log"), data= dataB, offset(areasampled))
modBR12 <-glm(richness ~ pH +elevation, data= dataB, family = poisson(link="log"), offset(areasampled))

modL1 <- glm(larvaldensity ~ chirodensity, data = dataB)
modL2 <-glm(larvaldensity ~ otherinvertsdensity, data = dataB)
modL3 <-glm(larvaldensity ~ otherinvertsdensity + chirodensity + darnerdensity , data = dataB)

# make list of models
modelsB <- list(modB6, modB7, modB8, modB9, modB10, modB12)
# names of models
mod_namesB <- c("pH-elevation-fish-lenticlotic-openwater-avgwatertemp",
"elevation-fish",
"pH-fish",
"ph-openwater",
"y=1",
"ph-elevation")
# makde AIC table
aictab(cand.set = modelsB, modnames = mod_namesB)

# make list of models
modelsBR <- list( modBR6, modBR7, modBR8,modBR9, modBR10, modBR12)
# names of models
mod_namesBR <- c("pH-elevation-fish-lenticlotic-openwater-avgwatertemp",
"elevation-fish",
"pH-fish",
"pH-openwater",
"y=1",
"ph-elevation")
# makde AIC table
aictab(cand.set = modelsBR, modnames = mod_namesBR)

# make list of models
modelsL <- list( modL1, modL2, modL3)
# names of models
mod_namesL <- c("Chironomids",
                "Other-Inverts",
                "otherinvertsdensity-chirodensity-darnerdensity")
# makde AIC table
aictab(cand.set = modelsL, modnames = mod_namesL)

```


scatterplot of amount of open water and abundances for wetlands for 2017 and 2018
```{r}

adultabund <- ggplot(dataA, aes(x=openwater, y=adjusted.abundance)) + geom_point() + xlab("Area of Open Water" ~m^2) + ylab("Adult Abundance")
adultrich <- ggplot(dataA, aes(x=openwater, y=adjusted.richness)) + geom_point() + xlab("Area of Open Water" ~m^2) + ylab("Adult Richness")

adultabundp <- ggplot(dataA, aes(x=pH, y=adjusted.abundance)) + geom_point() + xlab("pH") + ylab("Adult Abundance") + geom_smooth(method = "lm")
adultrichp <- ggplot(dataA, aes(x=pH, y=adjusted.richness)) + geom_point() + xlab("pH") + ylab("Adult Richness") + geom_smooth(method = "lm")

adultabunde <- ggplot(dataA, aes(x=elevation, y=adjusted.abundance)) + geom_point() + xlab("Elevation (m)") + ylab("Adult Abundance") + geom_smooth(method = "lm")
adultriche <- ggplot(dataA, aes(x=elevation, y=adjusted.richness)) + geom_point() + xlab("Elevation (m)") + ylab("Adult Richness") + geom_smooth(method = "lm")

adultabundt <- ggplot(dataA, aes(x=airtempdiff, y=adjusted.abundance)) + geom_point() + xlab("Air Temperature Difference" ~C) + ylab("Adult Abundance") + geom_smooth(method = "lm")
adultricht <- ggplot(dataA, aes(x=airtempdiff, y=adjusted.richness)) + geom_point() + xlab("Air Temperature Difference" ~C) + ylab("Adult Richness") + geom_smooth(method = "lm")

```


scatter plot for open water
```{r}
library(ggplot2)
nymphabund <- ggplot(dataB, aes(x=openwatersizem2, y=adjusted.abundance)) + geom_point() + xlab("Area of Open Water" ~m^2) + ylab("Nymph Abundance")
nymphrich <- ggplot(dataB, aes(x=openwatersizem2, y=adjusted.richness)) + geom_point() + xlab("Area of Open Water" ~m^2) + ylab("Nymph Richness") 

nymphabundp <- ggplot(dataB, aes(x=pH, y=adjusted.abundance)) + geom_point() + xlab("pH") + ylab("Nymph Abundance") 
nymphrichp <- ggplot(dataB, aes(x=pH, y=adjusted.richness)) + geom_point() + xlab("pH") + ylab("Nymph Richness") 

nymphabunde <- ggplot(dataB, aes(x=elevation, y=adjusted.abundance)) + geom_point() + xlab("Elevation (m)") + ylab("Nymph Abundance") 
nymphriche <- ggplot(dataB, aes(x=elevation, y=adjusted.richness)) + geom_point() + xlab("Elevation (m)") + ylab("Nymph Richness")

nymphabundt <- ggplot(dataB, aes(x=averagewatertemp, y=adjusted.abundance)) + geom_point() + xlab("Average Water Temperature" ~C) + ylab("Nymph Abundance") 
nymphricht <- ggplot(dataB, aes(x=averagewatertemp, y=adjusted.richness)) + geom_point() + xlab("Average Water Temperature" ~C) + ylab("Nymph Richness")

nymphabundc <- ggplot(dataB, aes(x=conductivity, y=adjusted.abundance)) + geom_point() + xlab("Conductivity") + ylab("Nymph Abundance") + geom_smooth(method = "lm")
nymphrichc <- ggplot(dataB, aes(x=conductivity, y=adjusted.richness)) + geom_point() + xlab("Conductivity") + ylab("Nymph Richness") + geom_smooth(method = "lm") 

data_comb <- dataB %>%
  mutate(openwater = openwatersizem2) %>%
  bind_rows(dataA) %>%
  filter(!is.na(Stage))

#graphs sidde by side but different scales, can't use because they aren't effort adjusted
library(gridExtra)
#openwater
grid.arrange(nymphabund, adultabund, nrow=1, ncol=2)
grid.arrange(nymphrich, adultrich, nrow=1, ncol=2)
grid.arrange(nymphabund, adultabund, nymphrich, adultrich, nrow=2, ncol=2)
#pH
grid.arrange(nymphabundp, adultabundp, nrow=1, ncol=2)
grid.arrange(nymphrichp, adultrichp, nrow=1, ncol=2)
grid.arrange(nymphabundp, adultabundp, nymphrichp, adultrichp, nrow=2, ncol=2)
#elevation
grid.arrange(nymphabunde, adultabunde, nrow=1, ncol=2)
grid.arrange(nymphriche, adultriche, nrow=1, ncol=2)
grid.arrange(nymphabunde, adultabunde, nymphriche, adultriche, nrow=2, ncol=2)
#temperature
grid.arrange(nymphabundt, adultabundt, nrow=1, ncol=2)
grid.arrange(nymphricht, adultricht, nrow=1, ncol=2)
grid.arrange(nymphabundt, adultabundt, nymphricht, adultricht, nrow=2, ncol=2)
#conductivity
grid.arrange(nymphabundc, nymphrichc, nrow=1, ncol=2)


pA <- ggplot() +
      # blue plot
      geom_point(data=dataA, aes(x=openwater, y=adjusted.abundance), fill="blue", colour="darkblue", size=1) +
      # red plot
      geom_point(data=dataB, aes(x=openwatersizem2, y=abundance), fill="red", colour="red", size=1) + xlab("Area of Open Water" ~(m^2)) + ylab("Abundance") + theme(legend.position = c(0.95, 0.95),
    legend.justification = c("right", "top"))
pA

# both combined with same color
ggplot(data = data_comb, aes(openwater, adjusted.abundance)) + geom_point()

# both combined with diff colors
ggplot(data = data_comb, aes(openwater, adjusted.abundance)) + geom_point(aes(color = Stage)) + xlab("Area of Open Water" ~(m^2)) + ylab("Abundance")

# both on own plots
ggplot(data = data_comb, aes(openwater, adjusted.abundance)) + geom_point(aes(color = Stage)) + xlab("Area of Open Water" ~(m^2)) + ylab("Abundance") + facet_wrap(~Stage)

# both on own plots + smooth trendline and black-white background
ggplot(data = data_comb, aes(openwater, adjusted.abundance)) + geom_point(aes(color = Stage)) + xlab("Area of Open Water" ~(m^2)) + ylab("Abundance") + facet_wrap(~Stage) + geom_smooth(method = "lm") + theme_bw()
```


richness scatter plots adults and nymphs
```{r}



dataB_comb2 <- dataB %>%
  mutate(openwater = openwatersizem2) %>%
  bind_rows(dataA) %>%
  filter(!is.na(Stage))


#graphs sidde by side but different scales, can't use because they aren't effort adjusted
library(gridExtra)
grid.arrange(nymphrich, adultrich, nrow=1, ncol=2)

# both combined with same color
ggplot(data = dataB_comb2, aes(openwater, Richness)) + geom_point()

# both combined with diff colors
ggplot(data = dataB_comb2, aes(openwater, Richness)) + geom_point(aes(color = Stage)) + xlab("Area of Open Water" ~(m^2)) + ylab("Richness")

# both on own plots
ggplot(data = dataB_comb2, aes(openwater, Richness)) + geom_point(aes(color = Stage)) + xlab("Area of Open Water" ~(m^2)) + ylab("Richness") + facet_wrap(~Stage)

# both on own plots + smooth trendline and black-white background
ggplot(data = dataB_comb2, aes(openwater, Richness)) + geom_point(aes(color = Stage)) + xlab("Area of Open Water" ~(m^2)) + ylab("Richness") + facet_wrap(~Stage) + geom_smooth(method = "lm") + theme_bw()

pR <- ggplot() +
      # blue plot
      geom_point(data=dataA, aes(x=openwater, y=Richness), fill="blue", colour="darkblue", size=1) +
      # red plot
      geom_point(data=dataB, aes(x=openwatersizem2, y=richness), fill="red", colour="red", size=1) + xlab("Area of Open Water" ~(m^2)) + ylab("Richness") + theme(
    legend.position = c(0.95, 0.95),
    legend.justification = c("right", "top")
  )
pR

```


```{r}
dataD <- read.csv("DragonflyTotalsMarkedvsRecapped.csv", stringsAsFactors = F)

adultrecap <- ggplot(dataD, aes(x=openwatersize, y=percentrecap)) + geom_point() + scale_y_continuous(labels=scales::percent)+ xlab("Area of Open Water" ~(m^2)) + ylab("Percent Recaptured")
adultrecap
```






```{r}

dataF <- read.csv("LarvalDensity.csv", stringsAsFactors = F)
larvaldensity <- ggplot(dataF, aes(x=pH, y=larvaldensity)) + geom_point() + xlab("pH") + ylab("Larval Density") #+ geom_text(aes(label=ID),hjust=.5, vjust=1.5)


chirodensity <- ggplot(dataF, aes(x=chirodensity, y=larvaldensity)) + geom_point() + xlab("Chironomid density") + ylab("Larval Density") #+ geom_text(aes(label=ID),hjust=.5, vjust=1.5)



pF <- ggplot() +
      # blue plot
      geom_point(data=dataF, aes(x=pH, y=larvaldensity), fill="blue", colour="darkblue", size=1) +
      # red plot
      geom_point(data=dataF, aes(x=pH, y=chirodensity), fill="red", colour="red", size=1) +
    #green plot
  geom_point(data=dataF, aes(x=pH, y=otherinvertsdensity), fill="green", colour="green", size=1) +
  geom_point(data=dataF, aes(x=pH, y=darnerdensity), fill="purple", colour="purple", size=1)  + xlab("pH") + ylab("Density")+ theme(legend.position = c(0.95, 0.95))
pF

```



violin/box plots- not doing these anymore
#```{r}
#do boxplots first for ID and nondragonfly and nondrgonfly
p <- ggplot(dataB, aes(x=ID, y=nondragonflyabundance)) + 
    geom_violin(trim=FALSE)
p + stat_summary(fun.data="mean_sdl", mult=1, 
                 geom="crossbar", width=0.2 )
p + stat_summary(fun.data=mean_sdl, mult=1, 
                 geom="pointrange", color="red")
data_summary <- function(nondragonflyabundace) {
   m <- mean(nondragonflyabundace)
   ymin <- m-sd(nondragonflyabundace)
   ymax <- m+sd(nondragonflyabundace)
   return(c(y=m,ymin=ymin,ymax=ymax))
}
dataB$ID <- as.factor(dataB$ID)

head(dataB)
p <- ggplot(dataB, aes(x=ID, y=nondragonflyabundance)) + 
  geom_violin()
p

p + stat_summary(fun.data=data_summary)
```

```{r}
dataC <- read.csv("NondragonflyNymphAbun2018.csv", stringsAsFactors = F)
str(dataC)

library(plyr)
#dataC$nondragonflyrichness <- apply(dataC[,-1]>0,1,sum)
#dataC$nondragonflyrichness
#nondragonflyrichness <- ddply(dataC,~Location,function(x) {data.frame(RICHNESS=sum(x[-1]>0))})
#nondragonflyrichness


#dataC$nondragonflyabundance <- apply(dataC[,-1],1,sum)
#dataC$nondragonflyabundance
#nondragonflyabundance <- ddply(dataC,~Location,function(x) {  data.frame(ABUNDANCE=sum(x[-1])) })
#nondragonfyabundance

dataC$Location <- as.factor(dataC$Location)

boxplot(dataC$Location,notch= T,
main="Nondragonfly Abundance Boxplots at Each Wetland",
xlab="Wetland",
ylab="Abundance",
col=c("orange"),
border="brown"
)
```







2017 and 2018 - can't do for nymphs because we didnt have a set sampling area
#```{r}
data <- read.csv("NymphAbund1718.csv", stringsAsFactors = F)

### Each possible combination of variables needs to be analyzed.  The lowest score (not counting the full model?) wins. #####
mod1<-glm(data$abundance~data$pH + offset(data$Area.sampled, family= poisson()))#poisson distribution,hav e family= posisson
mod2<-glm(data$abundance~data$elevation)
mod3<-glm(data$abundance~data$fishpresence)
mod4<-glm(data$abundance~data$lenticlotic)  
mod5<-glm(data$abundance~data$openwater)
mod6<-glm(data$abundance~data$pH*data$elevation)
mod7<-glm(data$abundance~data$pH*data$elevation*data$fishpresence)
mod8<-glm(data$abundance~data$pH*data$elevation*data$fishpresence*data$lenticlotic)
mod9<-glm(data$abundance~data$pH*data$elevation*data$fishpresence*data$lenticlotic*data$openwater) 
mod10<-glm(data$abundance~data$elevation*data$fishpresence)
mod11<-glm(data$abundance~data$elevation*data$fishpresence*data$lenticlotic)
mod12<-glm(data$abundance~data$elevation*data$fishpresence*data$lenticlotic*data$openwater)
mod13<-glm(data$abundance~data$fishpresence*data$lenticlotic)
mod14<-glm(data$abundance~data$fishpresence*data$openwater) #### Chicken dinner  #####
mod15<-glm(data$abundance~data$fishpresence*data$lenticlotic*data$openwater) #### Almost the same ####
mod16<-glm(data$abundance~data$lenticlotic*data$openwater)
mod17<-glm(data$abundance~data$pH*data$openwater)
#dont use p values!! null model - no covariates y~1. mot compolex with all covariates. a few interesting combos. 17 is too many. most likely to explain the data. DO based on experience and what literature says (be able to defend whatever ones chsen. Knit to word so maybe cn cut and paste into doc (to see if it loosk good otherwise csv)



```




these are all the JS and CJS for each location. Starting with NMBS
```{r}
capNMBS <- read.csv("capturehistoryNMBS.csv", stringsAsFactors = F)
str(capNMBS)
print(capNMBS)
summary(capNMBS)
capNMBS <- capNMBS[which(!is.na(capNMBS$c1)), ]
summary(capNMBS)

library(reshape)
## Format data for MARK

# get data formatted for MARK/RMark
capNMBS$ch <- paste(capNMBS$c1,
                capNMBS$c2,
                capNMBS$c3,
                capNMBS$c4,
                capNMBS$c5,
                capNMBS$c6,
                capNMBS$c7,
                capNMBS$c8,
                capNMBS$c9,
                capNMBS$c10,
                capNMBS$c11,
                capNMBS$c12,
                " ",
                ";",
                sep="")


data=data.frame(capNMBS)
data
transform=melt(capNMBS, id.vars="mark.number")
pivot=cast(transform, mark.number ~ value)
pivot[is.na(pivot)]=0

pivot[,2:ncol(pivot)][pivot[,2:ncol(pivot)] != 0] = 1
lh <- 11;


pivot$eh <- apply(pivot[2:lh],1,paste,collapse="") # concatenates encounter columns into eh
pivot[2:lh] <- NULL # drops individual encounter columns
# create commented tag
pivot$mark.number <- paste("/*", pivot$mark.number, "*/", sep=" ")
# sort by descending encounter histories
pivot <- pivot[order(data$ch,decreasing=TRUE),]
# tack on the frequency for the individual
pivot$end <- "1;";
# write out the input file
write.table(pivot,file="cjs-pivot.inp",sep=" ",quote=F,col.names=F,row.names=F);

pivot

```



```{r}
## Format data for marked package

marked_dfNMBS <- capNMBS

marked_dfNMBS$ch <- paste0(capNMBS$c1,
                capNMBS$c2,
                capNMBS$c3,
                capNMBS$c4,
                capNMBS$c5,
                capNMBS$c6,
                capNMBS$c7,
                capNMBS$c8,
                capNMBS$c9,
                capNMBS$c10,
                capNMBS$c11,
                capNMBS$c12)
                
marked_dfNMBS$sex.fac <- as.factor(marked_dfNMBS$sex)
marked_dfNMBS$species.fac <- as.factor(marked_dfNMBS$species)

model1=crm(marked_dfNMBS,  
          time.intervals = c(23, 4, 9, 2, 4, 15, 9, 1, 2, 7, 9),
          groups = c("sex.fac"), 
          model.parameters=list(Phi = list(formula = ~sex.fac)),
          hessian=TRUE)

model1
model=cjs.hessian(model1)
model1
model1$results$reals

model2=crm(marked_dfNMBS,  
          time.intervals = c(23, 4, 9, 2, 4, 15, 9, 1, 2, 7, 9),
          groups = c("sex.fac"), 
          model.parameters=list(p = list(formula = ~sex.fac)),
          hessian=TRUE)

model2
model=cjs.hessian(model2)
model2
model2$results$reals

model22=crm(marked_dfNMBS,  
          time.intervals = c(23, 4, 9, 2, 4, 15, 9, 1, 2, 7, 9),
          groups = c("sex.fac"), 
          model.parameters=list(Phi = list(formula = ~1), p= list(formula = ~1)),
          hessian=TRUE)

model22
model=cjs.hessian(model22)
model22$results$reals

model3=crm(marked_dfNMBS,  
          time.intervals = c(23, 4, 9, 2, 4, 15, 9, 1, 2, 7, 9),
          groups = c("species.fac"), 
          model.parameters=list(Phi = list(formula = ~species.fac)),
          hessian=TRUE)

model3
model=cjs.hessian(model3)
model3
model3$results$reals

model4=crm(marked_dfNMBS,  
          time.intervals = c(23, 4, 9, 2, 4, 15, 9, 1, 2, 7, 9),
          groups = c("species.fac"), 
          model.parameters=list(p = list(formula = ~species.fac)),
          hessian=TRUE)


model4
model=cjs.hessian(model4)
model4
model4$results$reals

model23=crm(marked_dfNMBS,  
          time.intervals = c(23, 4, 9, 2, 4, 15, 9, 1, 2, 7, 9),
          groups = c("species.fac"), 
          model.parameters=list(p = list(formula = ~1), Phi = list(formula = ~1)),
          hessian=TRUE)


model23
model=cjs.hessian(model23)
model23
model23$results$reals

```

CJS: AIC  :  184.6449, Phi.(Intercept) -0.4564347, p.(Intercept)   -1.5498460

looking at sex and species. phi= apparent survival estimate. p=capture probability (percents) N=population estimate

```{r}
str(marked_dfNMBS)
marked_dfNMBS$sex.fac <- as.factor(marked_dfNMBS$sex)
marked_dfNMBS$species.fac <- as.factor(marked_dfNMBS$species)
#modNMBS <- crm(marked_dfNMBS, 
        #model="JS", 
        #groups = c("sex.fac"), 
        #model.parameters=list(Phi = list(formula = ~sex.fac), 
                              #p = list(formula = ~1)))

modNMBS1 <- crm(marked_dfNMBS, 
        model="JS", 
        groups = c("sex.fac"), 
        time.intervals = c(23, 4, 9, 2, 4, 15, 9, 1, 2, 7, 9),
        model.parameters=list(N = list(formula = ~sex.fac)),
        hessian=TRUE)

modNMBS1$results$beta #found online but not sure how to use it
modNMBS1

cjs.hessian(modNMBS1)

str(modNMBS1)
# get values on real scale and not logit or log scales
modNMBS1$results$reals


#modNMBS <- crm(marked_dfNMBS, 
       # model="JS", 
       # groups = c("species.fac"), 
      #  model.parameters=list(Phi = list(formula = ~species.fac),    #should have for one or the other, not both
                           #   p = list(formula = ~species.fac)))

modNMBS2 <- crm(marked_dfNMBS, 
                model="JS", 
                groups = c("species.fac"), 
                time.intervals = c(23, 4, 9, 2, 4, 15, 9, 1, 2, 7, 9),
                model.parameters=list(N = list(formula = ~species.fac)),
                hessian=TRUE)

modNMBS2$results$beta 
modNMBS2
modNMBS2$results$reals
cjs.hessian(modNMBS2)

str(modNMBS2)
# get values on real scale and not logit or log scales
modNMBS2$results$reals

modNMBS3 <- crm(marked_dfNMBS, 
                model="JS", 
                groups = c("species.fac"), 
                time.intervals = c(23, 4, 9, 2, 4, 15, 9, 1, 2, 7, 9),
                model.parameters=list(N = list(formula = ~species.fac)),
                hessian=TRUE)

modNMBS3$results$beta 
modNMBS3
modNMBS3$results$reals

cjs.hessian(modNMBS3)

str(modNMBS3)
# get values on real scale and not logit or log scales
modNMBS3$results$reals

```

```{r}
#NMBS.table <- collect.models(type = "Jolly")

#This is supposed to get all the models into a nice table so I can compare AIC values but it isn't working (because it only works with RMark)

#####This is my reminder to find a way to make a table of my models AIC values#########
```



# Run with RMark (need to download Program MARK in order for this to work). This is looking at NMBS only

```{r}
#MarkPath='C:/Program Files (x86)/MARK'

#data(marked_dfCNMBS)
#p.sex = list(formula=~marked_dfNMBS$sex.fac)
#Phi.ct= list(formula=~1)
#p.ct = list(formula=~1)
#Phi.sex = list(formula=~marked_dfNMBS$sex.fac)

#mod5=mark(marked_dfNMBS, model = "CJS", model.parameters=list(p=p.ct, Phi=Phi.ct), output=FALSE, time.intervals = c(23, 4, 9, 2, 4, 15, 9, 1, 2, 7, 9))$results$beta

#mod6=mark(marked_dfNMBS, model = "CJS", model.parameters=list(p=p.sex, Phi=Phi.ct), output=FALSE, time.intervals = c(23, 4, 9, 2, 4, 15, 9, 1, 2, 7, 9))$results$beta

#mark(marked_dfNMBS, model.parameters=list(p=list(formula=~species.fac)),output=FALSE, time.intervals = c(23, 4, 9, 2, 4, 15, 9, 1, 2, 7, 9))$results$beta

#mark(marked_dfNMBS, model = "Jolly", model.parameters=list(p=list(formula=~1)),output=FALSE,time.intervals = c(23, 4, 9, 2, 4, 15, 9, 1, 2, 7, 9), options="SIMANNEAL")$results$beta
#This Jolly code doesn't run properly. 

```


####okay now for CT

```{r}
capCT <- read.csv("capturehistoryCT.csv", stringsAsFactors = F)
str(capCT)
print(capCT)
summary(capCT)
capCT <- capCT[which(!is.na(capCT$c1)), ]
summary(capCT)

library(reshape)
## Format data for MARK

# get data formatted for MARK/RMark
capCT$ch <- paste(capCT$c1,
                capCT$c2,
                capCT$c3,
                capCT$c4,
                capCT$c5,
                capCT$c6,
                capCT$c7,
                capCT$c8,
                capCT$c9,
                " ",
                ";",
                sep="")


data=data.frame(capCT)
data
transform=melt(capCT, id.vars="mark.number")
pivot=cast(transform, mark.number ~ value)
pivot[is.na(pivot)]=0

pivot[,2:ncol(pivot)][pivot[,2:ncol(pivot)] != 0] = 1
lh <- 11;


pivot$eh <- apply(pivot[2:lh],1,paste,collapse="") # concatenates encounter columns into eh
pivot[2:lh] <- NULL # drops individual encounter columns
# create commented tag
pivot$mark.number <- paste("/*", pivot$mark.number, "*/", sep=" ")
# sort by descending encounter histories
pivot <- pivot[order(data$ch,decreasing=TRUE),]
# tack on the frequency for the individual
pivot$end <- "1;";
# write out the input file
write.table(pivot,file="cjs-pivot.inp",sep=" ",quote=F,col.names=F,row.names=F);

pivot

```



```{r}
## Format data for marked package

marked_dfCT <- capCT

marked_dfCT$ch <- paste0(capCT$c1,
                capCT$c2,
                capCT$c3,
                capCT$c4,
                capCT$c5,
                capCT$c6,
                capCT$c7,
                capCT$c8,
                capCT$c9)
             
#model=crm(marked_dfCT, time.intervals = c(7, 8, 6, 7, 4, 9, 3, 7))
#model
#model=cjs.hessian(model)
#model

marked_dfCT$sex.fac <- as.factor(marked_dfCT$sex)
marked_dfCT$species.fac <- as.factor(marked_dfCT$species)

model5=crm(marked_dfCT,  
          time.intervals = c(7, 8, 6, 7, 4, 9, 3, 7),
          groups = c("sex.fac"), 
          model.parameters=list(Phi = list(formula = ~sex.fac)),
          hessian=TRUE)

model5
model=cjs.hessian(model5)
model5
model5$results$reals

model6=crm(marked_dfCT,  
          time.intervals = c(7, 8, 6, 7, 4, 9, 3, 7),
          groups = c("sex.fac"), 
          model.parameters=list(p = list(formula = ~sex.fac)),
          hessian=TRUE)

model6
model=cjs.hessian(model6)
model6
model6$results$reals

model25=crm(marked_dfCT,  
          time.intervals = c(7, 8, 6, 7, 4, 9, 3, 7),
          groups = c("sex.fac"), 
          model.parameters=list(p = list(formula = ~1), Phi = list(formula = ~1)),
          hessian=TRUE)

model25
model=cjs.hessian(model25)
model25
model25$results$reals

model7=crm(marked_dfCT,  
          time.intervals = c(7, 8, 6, 7, 4, 9, 3, 7),
          groups = c("species.fac"), 
          model.parameters=list(Phi = list(formula = ~species.fac)),
          hessian=TRUE)

model7
model=cjs.hessian(model7)
model7
model7$results$reals

model8=crm(marked_dfCT,  
          time.intervals = c(7, 8, 6, 7, 4, 9, 3, 7),
          groups = c("species.fac"), 
          model.parameters=list(p = list(formula = ~species.fac)),
          hessian=TRUE)


model8
model=cjs.hessian(model8)
model8
model8$results$reals

model26=crm(marked_dfCT,  
          time.intervals = c(7, 8, 6, 7, 4, 9, 3, 7),
          groups = c("species.fac"), 
          model.parameters=list(p = list(formula = ~1), Phi= list(formula = ~1)),
          hessian=TRUE)


model26
model=cjs.hessian(model26)
model26
model26$results$reals
```



looking at sex and species. phi= apparent survival estimate. p=capture probability (percents) N=population estimate

```{r}
str(marked_dfCT)
marked_dfCT$sex.fac <- as.factor(marked_dfCT$sex)
marked_dfCT$species.fac <- as.factor(marked_dfCT$species)
#modCT <- crm(marked_dfCT, 
        #model="JS", 
        #groups = c("sex.fac"), 
        #model.parameters=list(Phi = list(formula = ~sex.fac), 
                              #p = list(formula = ~1)))

modCT1 <- crm(marked_dfCT, 
        model="JS", 
        groups = c("sex.fac"), 
        time.intervals = c(7, 8, 6, 7, 4, 9, 3, 7),
        model.parameters=list(N = list(formula = ~sex.fac)),
        hessian=TRUE)

modCT1$results$beta 
modCT1

cjs.hessian(modCT1)

str(modCT1)
# get values on real scale and not logit or log scales
modCT1$results$reals


#modCT <- crm(marked_dfCT, 
        #model="JS", 
        #groups = c("species.fac"), 
        #model.parameters=list(Phi = list(formula = ~species.fac), 
                              #p = list(formula = ~species.fac)))

modCT2 <- crm(marked_dfCT, 
        model="JS", 
        groups = c("species.fac"), 
        time.intervals = c(7, 8, 6, 7, 4, 9, 3, 7),
        model.parameters=list(N = list(formula = ~species.fac)),
        hessian=TRUE)

modCT2$results$beta 
modCT2
modCT2$results$reals

modCT3 <- crm(marked_dfCT, 
        model="JS", 
        groups = c("species.fac"), 
        time.intervals = c(7, 8, 6, 7, 4, 9, 3, 7),
        model.parameters=list(N = list(formula = ~1)),
        hessian=TRUE)

modCT3$results$beta 
modCT3
modCT3$results$reals
```




# Run with RMark (need to download Program MARK in order for this to work). This is looking at CT only

```{r}
#MarkPath='C:/Program Files (x86)/MARK'

#data(marked_dfCT)
#p.sex = list(formula=~marked_dfCT$sex.fac)
#Phi.ct= list(formula=~1)
#p.ct = list(formula=~1)
#Phi.sex = list(formula=~marked_dfCT$sex.fac)

#mod1=mark(marked_dfCT, model = "CJS", model.parameters=list(p=p.ct, Phi=Phi.ct), time.intervals = c(7, 8, 6, 7, 4, 9, 3, 7), output=FALSE)$results$beta
#mod2=mark(marked_dfCT, model = "CJS", model.parameters=list(p=p.sex, Phi=Phi.ct), time.intervals = c(7, 8, 6, 7, 4, 9, 3, 7), output=FALSE)$results$beta
#mod3=mark(marked_dfCT, model = "CJS", model.parameters=list(p=p.ct, Phi=Phi.sex), time.intervals = c(7, 8, 6, 7, 4, 9, 3, 7), output=FALSE)$results$beta
#mod4=mark(marked_dfCT, model = "CJS", model.parameters=list(p=p.sex, Phi=Phi.sex), time.intervals = c(7, 8, 6, 7, 4, 9, 3, 7), output=FALSE)$results$beta

#mod2=mark(marked_dfCT, model = "Jolly", model.parameters=list(N=list(formula=~1)), time.intervals = c(7, 8, 6, 7, 4, 9, 3, 7), output=FALSE, options="SIMANNEAL")$results$beta

#THIS RUNS REALLY SLOW. I read in the package doc that Jolly often doesn't run at all, which is why there is the options part in this code. Without it, it won't run at all. With it, it runs, but takes forever and doesn't ever fully converge 
#####

#mark(marked_dfCT, model.parameters=list(Phi=sex.fac),output=FALSE)$results$beta

```




```{r}
#??Rmark

#CT.table <- collect.models(type = "CJS")

```




For just crimsons at NMBS
#```{r}

capC <- read.csv("capturehistoryCrimsonsNMBS.csv", stringsAsFactors = F)
str(capC)
print(capC)
summary(capC)
capC <- capC[which(!is.na(capC$c1)), ]
summary(capC)

library(reshape)
## Format data for MARK

# get data formatted for MARK/RMark
capC$ch <- paste(capC$c1,
                capC$c2,
                capC$c3,
                capC$c4,
                capC$c5,
                capC$c6,
                capC$c7,
                capC$c8,
                capC$c9,
                capC$c10,
                capC$c11,
                capC$c12,
                " ",
                ";",
                sep="")


data=data.frame(capC)
data
transform=melt(capC, id.vars="mark.number")
pivot=cast(transform, mark.number ~ value)
pivot[is.na(pivot)]=0

pivot[,2:ncol(pivot)][pivot[,2:ncol(pivot)] != 0] = 1
lh <- 11;


pivot$eh <- apply(pivot[2:lh],1,paste,collapse="") # concatenates encounter columns into eh
pivot[2:lh] <- NULL # drops individual encounter columns
# create commented tag
pivot$mark.number <- paste("/*", pivot$mark.number, "*/", sep=" ")
# sort by descending encounter histories
pivot <- pivot[order(data$ch,decreasing=TRUE),]
# tack on the frequency for the individual
pivot$end <- "1;";
# write out the input file
write.table(pivot,file="cjs-pivot.inp",sep=" ",quote=F,col.names=F,row.names=F);

pivot

```



#```{r}
## Format data for marked package

marked_dfC <- capC

marked_dfC$ch <- paste0(capC$c1,
                capC$c2,
                capC$c3,
                capC$c4,
                capC$c5,
                capC$c6,
                capC$c7,
                capC$c8,
                capC$c9,
                capC$c10,
                capC$c11,
                capC$c12)
             
marked_dfC$sex.fac <- as.factor(marked_dfC$sex)
marked_dfC$species.fac <- as.factor(marked_dfC$species)

#CJS
modelC1=crm(marked_dfC,  
          time.intervals = c(23, 4, 9, 2, 4, 15, 9, 1, 2, 7, 9),
          groups = c("sex.fac"), 
          model.parameters=list(Phi = list(formula = ~sex.fac)),
          hessian=TRUE)

modelC1
model=cjs.hessian(modelC1)
modelC1
modelC1$results$reals

modelC2=crm(marked_dfC,  
          time.intervals = c(23, 4, 9, 2, 4, 15, 9, 1, 2, 7, 9),
          groups = c("sex.fac"), 
          model.parameters=list(p = list(formula = ~sex.fac)),
          hessian=TRUE)

modelC2
model=cjs.hessian(modelC2)
modelC2
modelC2$results$reals

modelC4=crm(marked_dfC,  
          time.intervals = c(23, 4, 9, 2, 4, 15, 9, 1, 2, 7, 9),
          groups = c("sex.fac"), 
          model.parameters=list(p = list(formula = ~1), Phi = (list(formula = ~1))),
          hessian=TRUE)

modelC4
model=cjs.hessian(modelC4)
modelC4
modelC4$results$reals

#JS

modC3 <- crm(marked_dfC, 
        model="JS", 
        groups = c("sex.fac"), 
        time.intervals = c(23, 4, 9, 2, 4, 15, 9, 1, 2, 7, 9),
        model.parameters=list(N = list(formula = ~sex.fac)),
        hessian=TRUE)
modC3$results$reals

modC4 <- crm(marked_dfC, 
        model="JS", 
        groups = c("sex.fac"), 
        time.intervals = c(23, 4, 9, 2, 4, 15, 9, 1, 2, 7, 9),
        model.parameters=list(N = list(formula = ~1)),
        hessian=TRUE)
modC4$results$reals

```

#####revised cap hist for NMBS Crimsons#######
```{r}

capC <- read.csv("capturehistoryCrimsonsNMBS2.csv", stringsAsFactors = F)
str(capC)
print(capC)
summary(capC)
capC <- capC[which(!is.na(capC$c1)), ]
summary(capC)

library(reshape)
## Format data for MARK

# get data formatted for MARK/RMark
capC$ch <- paste(capC$c1,
                capC$c2,
                capC$c3,
                capC$c4,
                capC$c5,
                capC$c6,
                capC$c7,
                capC$c8,
                " ",
                ";",
                sep="")


data=data.frame(capC)
data
transform=melt(capC, id.vars="mark.number")
pivot=cast(transform, mark.number ~ value)
pivot[is.na(pivot)]=0

pivot[,2:ncol(pivot)][pivot[,2:ncol(pivot)] != 0] = 1
lh <- 11;


pivot$eh <- apply(pivot[2:lh],1,paste,collapse="") # concatenates encounter columns into eh
pivot[2:lh] <- NULL # drops individual encounter columns
# create commented tag
pivot$mark.number <- paste("/*", pivot$mark.number, "*/", sep=" ")
# sort by descending encounter histories
pivot <- pivot[order(data$ch,decreasing=TRUE),]
# tack on the frequency for the individual
pivot$end <- "1;";
# write out the input file
write.table(pivot,file="cjs-pivot.inp",sep=" ",quote=F,col.names=F,row.names=F);

pivot

```



```{r}
## Format data for marked package

marked_dfC <- capC

marked_dfC$ch <- paste0(capC$c1,
                capC$c2,
                capC$c3,
                capC$c4,
                capC$c5,
                capC$c6,
                capC$c7,
                capC$c8)
             
marked_dfC$sex.fac <- as.factor(marked_dfC$sex)
marked_dfC$species.fac <- as.factor(marked_dfC$species)

#CJS
modelC1=crm(marked_dfC,  
          time.intervals = c(4, 15, 9, 1, 2, 7, 9),
          groups = c("sex.fac"), 
          model.parameters=list(Phi = list(formula = ~sex.fac)),
          hessian=TRUE)

modelC1
model=cjs.hessian(modelC1)
modelC1
modelC1$results$reals

modelC2=crm(marked_dfC,  
          time.intervals = c(4, 15, 9, 1, 2, 7, 9),
          groups = c("sex.fac"), 
          model.parameters=list(p = list(formula = ~sex.fac)),
          hessian=TRUE)

modelC2
model=cjs.hessian(modelC2)
modelC2
modelC2$results$reals

modelC4=crm(marked_dfC,  
          time.intervals = c(4, 15, 9, 1, 2, 7, 9),
          groups = c("sex.fac"), 
          model.parameters=list(p = list(formula = ~1), Phi = (list(formula = ~1))),
          hessian=TRUE)

modelC4
model=cjs.hessian(modelC4)
modelC4
modelC4$results$reals

#JS

modC3 <- crm(marked_dfC, 
        model="JS", 
        groups = c("sex.fac"), 
        time.intervals = c(4, 15, 9, 1, 2, 7, 9),
        model.parameters=list(N = list(formula = ~sex.fac)),
        hessian=TRUE)
modC3
modC3$results$reals

modC4 <- crm(marked_dfC, 
        model="JS", 
        groups = c("sex.fac"), 
        time.intervals = c(4, 15, 9, 1, 2, 7, 9),
        model.parameters=list(N = list(formula = ~1)),
        hessian=TRUE)
modC4
modC4$results$reals

```

CJS and JS could not be run for any other mark/recap site because there were not enough recaptures and I'm not even going to waste my time right now.

Hudsonians at CT
```{r}
capT <- read.csv("capturehistoryCTHud.csv", stringsAsFactors = F)
str(capT)
print(capT)
summary(capT)
capT <- capT[which(!is.na(capT$c1)), ]
summary(capT)

library(reshape)
## Format data for MARK

# get data formatted for MARK/RMark
capT$ch <- paste(capT$c1,
                capT$c2,
                capT$c3,
                capT$c4,
                capT$c5,
                capT$c6,
                capT$c7,
                capT$c8,
                capT$c9,
                " ",
                ";",
                sep="")


data=data.frame(capT)
data
transform=melt(capT, id.vars="mark.number")
pivot=cast(transform, mark.number ~ value)
pivot[is.na(pivot)]=0

pivot[,2:ncol(pivot)][pivot[,2:ncol(pivot)] != 0] = 1
lh <- 11;


pivot$eh <- apply(pivot[2:lh],1,paste,collapse="") # concatenates encounter columns into eh
pivot[2:lh] <- NULL # drops individual encounter columns
# create commented tag
pivot$mark.number <- paste("/*", pivot$mark.number, "*/", sep=" ")
# sort by descending encounter histories
pivot <- pivot[order(data$ch,decreasing=TRUE),]
# tack on the frequency for the individual
pivot$end <- "1;";
# write out the input file
write.table(pivot,file="cjs-pivot.inp",sep=" ",quote=F,col.names=F,row.names=F);

pivot

```



```{r}
## Format data for marked package

marked_dfT <- capT

marked_dfT$ch <- paste0(capT$c1,
                capT$c2,
                capT$c3,
                capT$c4,
                capT$c5,
                capT$c6,
                capT$c7,
                capT$c8,
                capT$c9)


marked_dfT$sex.fac <- as.factor(marked_dfT$sex)
marked_dfT$species.fac <- as.factor(marked_dfT$species)


#CJS
modelT5=crm(marked_dfT,  
          time.intervals = c(7, 8, 6, 7, 4, 9, 3, 7),
          groups = c("sex.fac"), 
          model.parameters=list(Phi = list(formula = ~sex.fac)),
          hessian=TRUE)

modelT5
model=cjs.hessian(modelT5)
modelT5
modelT5$results$reals

modelT7=crm(marked_dfT,  
          time.intervals = c(7, 8, 6, 7, 4, 9, 3, 7),
          groups = c("sex.fac"), 
          model.parameters=list(p = list(formula = ~sex.fac)),
          hessian=TRUE)

modelT7
model=cjs.hessian(modelT7)
modelT7
modelT7$results$reals

modelT6=crm(marked_dfT,  
          time.intervals = c(7, 8, 6, 7, 4, 9, 3, 7),
          groups = c("sex.fac"), 
          model.parameters=list(Phi = list(formula = ~1), p = list(formula=~1)),
          hessian=TRUE)

modelT6
model=cjs.hessian(modelT6)
modelT6
modelT6$results$reals

#JS
modT1 <- crm(marked_dfT, 
        model="JS", 
        groups = c("sex.fac"), 
        time.intervals = c(7, 8, 6, 7, 4, 9, 3, 7),
        model.parameters=list(N = list(formula = ~sex.fac)),
        hessian=TRUE)

modT1$results$beta 
modT1

cjs.hessian(modT1)

str(modT1)
# get values on real scale and not logit or log scales
modT1$results$reals

modT2 <- crm(marked_dfT, 
        model="JS", 
        groups = c("sex.fac"), 
        time.intervals = c(7, 8, 6, 7, 4, 9, 3, 7),
        model.parameters=list(N = list(formula = ~1)),
        hessian=TRUE)

modT2$results$beta 
modT2

cjs.hessian(modT2)

str(modT2)
# get values on real scale and not logit or log scales
modT2$results$reals

```

